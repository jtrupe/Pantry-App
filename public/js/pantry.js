var ingredientSearchTimeout;
var userID = window.sessionStorage.getItem("loggedInUser");

$("#ingredient-search").keyup(function() {
  function getAutofillData() {
    $.ajax({
      url: "/api/ingredient/search",
      type: "GET",
      data: { ingredientName: itemToSearch }
    }).done(function(res) {
      $(".returned-search-items").empty();
      res.forEach(function(val) {
        console.log(val.name);
        var newDiv = $("<div>");
        var itemRaw = val.name;
        newDiv.text(val.name);
        newDiv.addClass("ml-3 font-weight");
        var hr = $("<hr>");
        // var itemName = $("<p>").text(val.name);
        var addBtn = $("<button>").text("âž•");
        //added attributes to buttons generated by search
        addBtn.attr(
          "class",
          "newItem btn btn-outline-dark float-right pl-2 pr-1"
        );
        addBtn.attr("name", itemRaw);
        // newDiv.append(itemName);
        newDiv.append(addBtn);
        newDiv.append(hr);
        $(".returned-search-items").append(newDiv);
      });
      //move this out of for each
      $(".newItem").click(function() {
        var newItem = this.name;
        console.log("Adding New Item to Pantry: " + newItem);
        $.ajax({
          url: "/api/pantry/new",
          method: "POST",
          data: {
            name: newItem,
            user: userID
          }
        }).then(function(res) {
          console.log(res);
        });
      });
    });
  }
  clearTimeout(ingredientSearchTimeout);

  var itemToSearch = $("#ingredient-search")
    .val()
    .trim();
  $(".returned-search-items").empty();

  // this ensures an empty itemToSearch cannot be queried to the API
  if (itemToSearch.length === 0) {
    return;
  }
  ingredientSearchTimeout = setTimeout(getAutofillData, 500);
});

// event listener to alter quantity of pantry item
$(".pantry-item-alter").click(function() {
  var itemId = this.value;
  console.log("Alter item quantity ID " + itemId + " from user database");
  $.ajax({
    url: "/pantry/ingredient/update",
    type: "PUT",
    data: { ingredientId: itemId }
  }).done(function(res) {
    console.log("Done");
    window.location = res.redirect;
  });
});

// event listener to remove pantry item
$(".pantry-item-remove").click(function() {
  var itemId = this.value;
  console.log("Remove item ID " + itemId + " from user database");
  $.ajax({
    url: "/pantry/ingredient/remove",
    type: "DELETE",
    data: { ingredientId: itemId }
  }).done(function(res) {
    console.log("Done");
    window.location = res.redirect;
  });
});
